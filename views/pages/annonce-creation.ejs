<main class="container">
  <section class="card">
    <header class="card-head">
      <h1 class="card-title">Créer une annonce</h1>
    </header>

    <form class="form" method="POST" enctype="multipart/form-data">

      <!-- Message d'erreur qui s'affiche s'il existe -->
      <% if (error) { %>
        <div class="error-message">
          <p><%- error.replace(/\n/g, '<br>') %></p>
        </div>
      <% } %>

      <!-- INPUT >   Title -->
      <div class="field">
        <label for="title" class="label">Titre</label>
        <input id="title" type="text" name="title" class="input" placeholder="Titre de la vente" value="<%= titleInput %>">
      </div>

      <!-- INPUT >   Description -->
      <div class="field">
        <label for="description" class="label">Description</label>
        <textarea id="description" name="description" class="input input-area" placeholder="Description de la vente"><%= descriptionInput %></textarea>
      </div>

      <!-- INPUT > Image -->
      <div class="field">
        <label for="image" class="label">Image</label>
        <div class="image-upload-container">
          <label for="image" class="image-upload-btn">Choisir une image</label>
          <input id="image" type="file" name="image" class="image-input" accept="image/*">
          <img id="preview" class="preview-img" alt="Aperçu">
        </div>
        <small class="field-hint">Formats acceptés : JPG, PNG, WEBP. Taille max : 5 MB</small>
      </div>
            
      <!-- INPUT >   Adresse -->
      <div class="field">
        <label for="address" class="label">Address</label>
        <input id="address" type="text" name="address" class="input" placeholder="Adresse" value="<%= addressInput %>">
      </div>

      <!-- INPUT >   Prix -->
      <div class="field">
        <label for="price" class="label">Prix</label>
        <input id="price" type="number" name="price" class="input" placeholder="Prix" value="<%= priceInput %>" min="0.01" step="0.01">
      </div>

      <!-- INPUT >   Quantité -->
      <div class="field">
        <label for="quantity" class="label">Quantité</label>
        <input id="quantity" type="number" name="quantity" class="input" placeholder="Quantité" value="<%= quantityInput %>" min="1" step="1">
      </div>

      <!-- SELECT >   Catégorie -->
      <div class="field">
        <label for="category" class="label">Catégorie</label>
        <select id="category" name="category" class="input" required>
          <% if (!categoryInput) { %>
            <option value="" disabled selected>Sélectionnez une catégorie</option>
          <% } %>
          <% for(let categoryName in categoryData) { %>
            <% if (categoryName == categoryInput) { %>
              <option value="<%= categoryName %>" selected><%= categoryName %></option>
            <% } else {  %>
              <option value="<%= categoryName %>"><%= categoryName %></option>
            <% } %>
          <% } %>
        </select>
      </div>

      <!-- ZZone dynamique pour les filtres spécifiques -->
      <div id="dynamic-fields"></div>
      
      <!-- BUTTON >   Envoyer le formulaire -->
      <div class="actions">
        <button class="btn" type="submit">Publier votre annonce</button>
      </div>

    </form>
  </section>

  <script>
    const categoryData = <%- JSON.stringify(categoryData) %>;

    // Fonction pour créer les champs dynamiques
    function updateDynamicFields(category) {
      const container = document.getElementById('dynamic-fields');
      container.innerHTML = ''; // Vider les champs précédents

      // Si aucune catégorie n'est séléctionnée (ou que c'est une erreur),
      // alors rien n'est affiché.
      if (!category || !categoryData[category]) {
        return;
      }

      
      // Créer des inputs pour chaque filtre de la catégorie
      categoryData[category].forEach(filter => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'field';

        const label = document.createElement('label');
        label.className = 'label';
        label.textContent = filter.name;
        
        const fieldId = `filter_${filter.name}`
        label.setAttribute('for', fieldId);


        let input;

        if (filter.type === 'select') { // Si l'input est une sélection de valeurs
          input = document.createElement('select');
          input.className = 'input';
          input.id = fieldId;
          input.name = `filter[${filter.name}]`;

          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = `Sélectionnez ${filter.name.toLowerCase()}`;
          defaultOption.disabled = true;
          defaultOption.selected = true;
          input.appendChild(defaultOption);

          filter.values.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            input.appendChild(option);
          });

        } else if (filter.type === 'number') {
          input = document.createElement('input');
          input.type = 'number';
          input.className = 'input';
          input.id = fieldId;
          input.name = `filter[${filter.name}]`;
          input.placeholder = filter.name;
          input.min = '0';
        }

        fieldDiv.appendChild(label);
        fieldDiv.appendChild(input);
        container.appendChild(fieldDiv);
      });
    }

    // Écouteur d'événement sur le changement de catégorie
    document.getElementById('category').addEventListener('change', function(e) {
      updateDynamicFields(e.target.value);
    });

    // Initialiser les champs si une catégorie est déjà sélectionnée
    const selectedCategory = document.getElementById('category').value;
    if (selectedCategory) {
      updateDynamicFields(selectedCategory);
    }

    // Gestion de l'aperçu d'image
    document.getElementById('image').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const preview = document.getElementById('preview');
      
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.classList.add('show');
        };
        reader.readAsDataURL(file);
      } else {
        preview.classList.remove('show');
      }
    });
  </script>

</main>