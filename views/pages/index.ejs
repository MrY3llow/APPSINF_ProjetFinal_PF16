<main class="page-layout">

  <!-- Barre latérale gauche avec les filtres de recherche -->
  <div class="left-space-wrapper">
    <aside class="left-space">

      <!-- Barre d'input pour définir un prix min et max -->
      <div class="toolbox-inputs">
        <div class="price-group">
          <label class="label">Prix</label>
          <div class="price-inputs">
            <div class="field">
              <input type="text" id="input1" class="input" placeholder="min">
            </div>
            
            <span class="price-separator">–</span>
            
            <div class="field">
              <input type="text" id="input2" class="input" placeholder="max">
            </div>
          </div>
        </div>

        <!-- Dropdown pour sélectionner une catégorie principale -->
        <div class="field">
          <label class="label" for="category-select">Catégories</label>
          <select id="category-select" class="input">
            <option value=""> ~ </option>
            <% Object.keys(categoryData).forEach(category => { %>
              <option value="<%= category %>"><%= category %></option>
            <% }); %>
          </select>
        </div>

        <div class="separator"></div>

        <!-- Génération des sous-catégories pour chaque catégorie -->
        <% Object.entries(categoryData).forEach(([categoryName, fields]) => { %>
          <% fields.forEach(field => { %>
            
            <% if (field.type === 'select') { %>
              <!-- Sous-catégorie de type select (multi-select) -->
              <div id="<%= categoryName %>-<%= field.name %>-field" 
                  class="sub-dropdown" 
                  data-category="<%= categoryName %>" 
                  style="display: none;">
                <button class="dropdown-toggle"><%= field.name %></button>
                <div class="dropdown-options">
                  <% field.values.forEach(value => { %>
                    <label>
                      <input type="checkbox" value="<%= value %>"><%= value %>
                    </label>
                  <% }); %>
                </div>
              </div>
            <% } else if (field.type === 'number') { %>
              <!-- Sous-catégorie de type number (format min-max) -->
              <div id="<%= categoryName %>-<%= field.name %>-field" 
                  class="sub-field price-group" 
                  data-category="<%= categoryName %>" 
                  style="display: none;">
                <label class="label"><%= field.name %></label>
                <div class="price-inputs">
                  <div class="field">
                    <input type="number" class="input" placeholder="min">
                  </div>
                  
                  <span class="price-separator">–</span>
                  
                  <div class="field">
                    <input type="number" class="input" placeholder="max">
                  </div>
                </div>
              </div>
            <% } %>
            
          <% }); %>
        <% }); %>

      </div>

      <!-- Bouton pour appliquer les filtres -->
      <button type="button" id="apply-filters-btn" class="btn" style="margin-top: 20px; width: 100%;">
        Appliquer les filtres
      </button>

    </aside>
  </div>


  <div class="container">

    <section class="card">
      <header class="card-head">
        <div class="card-head-content">
          <h1 class="card-title">Produits disponibles</h1>
          
          <!-- Barre de tri -->
          <div class="sort-bar">
            <label for="sort-select" class="sort-label">Trier par :</label>
            <select id="sort-select" class="sort-select">
              <option value="">Par défaut</option>
              <option value="price-asc">Prix croissant</option>
              <option value="price-desc">Prix décroissant</option>
              <option value="rating">Rating vendeur</option>
              <option value="date-asc">Date croissante</option>
              <option value="date-desc">Date décroissante</option>
            </select>
          </div>
        </div>
      </header>

      <div class="products-grid">

        <!-- Affiche les différentes ventes en utilisant le modèle -->
        <% for (let sell of sells) { if (sell.quantity > 0) { %>
          <%- include('../partials/product-card', {sell: sell}) %>
        <% } } %>

        <!-- Si aucune vente -->
        <% if (sells.length == 0) { %>
          <p>Aucune vente pour l'instant<p>
        <% } %>

      </div>
    </section>
    
  </div>
</main>

<script>
  // Afficher/masquer les sous-catégories selon la catégorie sélectionnée
  document.getElementById('category-select').addEventListener('change', function() {
    const selectedCategory = this.value;
    
    // Masquer tous les champs de sous-catégories
    document.querySelectorAll('.sub-dropdown, .sub-field').forEach(field => {
      field.style.display = 'none';
    });
    
    // Afficher uniquement les champs de la catégorie sélectionnée
    if (selectedCategory) {
      document.querySelectorAll(`[data-category="${selectedCategory}"]`).forEach(field => {
        field.style.display = 'block';
      });
    }
  });

  // Gestion des dropdowns multi-select
  document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
    toggle.addEventListener('click', function(e) {
      e.preventDefault();
      const options = this.nextElementSibling;
      options.style.display = options.style.display === 'block' ? 'none' : 'block';
    });
  });

  // Gestion du bouton d'application des filtres
  document.getElementById('apply-filters-btn').addEventListener('click', function() {
    const params = new URLSearchParams();
    
    // Prix min/max
    const priceMin = document.getElementById('input1').value;
    const priceMax = document.getElementById('input2').value;
    if (priceMin) params.append('priceMin', priceMin);
    if (priceMax) params.append('priceMax', priceMax);
    
    // Catégorie principale
    const category = document.getElementById('category-select').value;
    if (category) params.append('category', category);
    
    // Sous-catégories select (checkboxes)
    document.querySelectorAll('.sub-dropdown').forEach(dropdown => {
      if (dropdown.style.display !== 'none') {
        const fieldName = dropdown.id.split('-').slice(1, -1).join('-');
        const checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        const values = Array.from(checkedBoxes).map(cb => cb.value);
        if (values.length > 0) {
          params.append(`categoryFilters[${fieldName}]`, values.join(','));
        }
      }
    });
    
    // Sous-catégories number (min-max)
    document.querySelectorAll('.sub-field').forEach(field => {
      if (field.style.display !== 'none') {
        const fieldName = field.id.split('-').slice(1, -1).join('-');
        const inputs = field.querySelectorAll('input[type="number"]');
        const min = inputs[0].value;
        const max = inputs[1].value;
        if (min) params.append(`categoryFilters[${fieldName}_min]`, min);
        if (max) params.append(`categoryFilters[${fieldName}_max]`, max);
      }
    });
    
    // Redirection vers la page d'accueil avec les paramètres
    window.location.href = '/?' + params.toString();
  });



  // Gestion du tri des produits
  document.getElementById('sort-select').addEventListener('change', function() {
    const sortValue = this.value;
    const params = new URLSearchParams(window.location.search);
    
    if (sortValue) {
      params.set('sort', sortValue);
    } else {
      params.delete('sort');
    }
    
    // Redirection avec le paramètre de tri
    window.location.href = '/?' + params.toString();
  });

  // Pré-sélectionner l'option de tri si présente dans l'URL
  window.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const sortValue = params.get('sort');
    
    if (sortValue) {
      document.getElementById('sort-select').value = sortValue;
    }
  });
</script>