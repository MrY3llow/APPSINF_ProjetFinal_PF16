<main class="container">
  <section class="card profile-card">

    <div class="profile-header">

      <div class="profile-header-info">
        <div class="profile-photo-wrapper">
        <img src="/image/user/<%= user.username %>" alt="Photo de profil" class="profile-photo">
        <div class="profile-shortcuts">
          <a href="sale-history" class="btn-outline">Mes ventes</a>
          <a href="purchase-history" class="btn-outline">Mes achats</a>
        </div>
        <h2 class="profile-username"><%= user.username %></h2>
      </div>
      
      <p class="profile-points">Points : <%= user.points %></p>
        <div class="profile-stars">★★★★★</div> <!-- [TODO] Afficher les étoiles selon user.rankingAverage (de 1 à 5) -->
        <div class="profile-balance"><%= user.balance %> €</div>
      <div class="actions">
        <input
          type="number"
          id="add-balance-input"
          class="input"
          placeholder="Montant en €"
          min="1"
          step="0.01"
        />
        <button class="btn-outline" id="add-balance-btn">
          Valider
        </button>
      </div>

      
      <!-- INPUT > Image -->
      <div class="field">
        <label for="image" class="label">Modifier la photo de profile</label>
        <div class="image-upload-container">
          <label for="image" class="image-upload-btn">Choisir une image</label>
          <input id="image" type="file" name="image" class="image-input" accept="image/*">
        </div>
        <small class="field-hint">Formats acceptés : JPG, PNG, WEBP. Taille max : 5 MB</small>
      </div>
        
      </div>

    </div>

    <div class="profile-body">
      <div class="field" id="change-password-field">
        <label class="label">Modifier mot de passe</label>
        <input type="password" id="new-password" class="input" placeholder="Entrer un nouveau mot de passe">
        <input type="password" id="copy-new-password" class="input" placeholder="Confirmer le mot de passe">
        <button class="btn" id="change-password-btn">Changer de mot de passe</button>
      </div>
      
      <div class="profile-actions">
        <a href="/logout">
          <button class="btn profile-logout">Déconnexion</button>
        </a>
      </div>

    </div>
  </section>

  <script>
    // Gestion changement de mot de passe
    document.getElementById('change-password-btn').addEventListener('click', async () => {
      const newPassword = document.getElementById('new-password').value;
      const copyNewPassword = document.getElementById('copy-new-password').value;

      try {
        const response = await fetch('/profile/PasswordChange', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ newPassword, copyNewPassword })
        });

        // Parser la réponse JSON
        const data = await response.json();

        if (response.ok) {
          // Afficher le message de succès retourné par le serveur
          alert(data.message || 'Mot de passe changé avec succès');
          document.getElementById('new-password').value = '';
          document.getElementById('copy-new-password').value = '';
        } else {
          // Afficher le message d'erreur retourné par le serveur
          alert(data.error || 'Erreur lors du changement de mot de passe');
        }
      } catch (error) {
        alert('Erreur de connexion au serveur');
      }
    });
      
    
    // Gestion de l'envoi de l'image au serveur
    document.getElementById('image').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      
      if (file && file.type.startsWith('image/')) {
        // Envoyer l'image au serveur
        const formData = new FormData();
        formData.append('image', file);

        try {
          const response = await fetch('/profile/updateImage', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            // Recharger la page pour afficher la nouvelle photo
            window.location.reload();
          } else {
            console.error('Erreur lors de l\'upload:', response.statusText);
            alert('Erreur lors de la mise à jour de la photo de profil');
          }
        } catch (error) {
          console.error('Erreur réseau:', error);
          alert('Erreur de connexion au serveur');
        }
      }
    });

  // Gestion de l'ajout de fonds
  document.getElementById('add-balance-btn').addEventListener('click', async () => {
    const input = document.getElementById('add-balance-input');
    const value = input.value;

    if (!value) {
      alert('Veuillez entrer un montant valide');
      return;
    }

    try {
      const response = await fetch(`/profile/addBalance/${value}`, {
        method: 'POST'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Erreur lors de l\'ajout des fonds');
      }
    } catch (error) {
      console.error(error);
      alert('Erreur de connexion au serveur');
    }
  });
  </script>

</main>